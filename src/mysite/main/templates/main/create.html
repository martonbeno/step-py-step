<html>
	<head>
		{% load static %}
		<!--<link rel="stylesheet" href="{% static 'style.css' %}">-->
		<link rel="stylesheet" href="{% static 'masikstyle.css' %}">
		<link rel="stylesheet" href="{% static 'sh_style.css' %}">
		<link rel="stylesheet" href="{% static 'Treant.css' %}">
		<!--<link rel="stylesheet" href="{% static 'super-simple.css' %}">-->

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script type="text/javascript" src="{% static 'sh_main.js' %}"></script>
		<script type="text/javascript" src="{% static 'sh_python.js' %}"></script>
		<script>
			var SOURCE_CODE = '';
			var DATA = {'lineno':1, 'localvars':[]};
			var ROWS = {}; //key: pointer, value: element
			var ONLY_GLOBAL_POINTERS = [];
			var EXPRESSION_ANALYSIS_IT = null;
			
			function py_api_request(command, args, callback){
				$.ajax({
					url: '/api/',
					method: 'POST',
					data: {
						command: command,
						args: JSON.stringify(args),
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					success: callback
				}).done(function(msg) {
					//semmi
				});
			}


			function testButtonPressed(){
				
				//let nodeStructure = DATA['expr']['treant'];
				//nodeStructure = JSON.stringify(nodeStructure);
				nodeStructure = '{"text":{"name":"Compare","title":"","desc":"a<b"},"children":[{"text":{"name":"Name","title":2,"desc":"a"},"children":[{"text":{"name":"Load","title":""},"children":[]}]},{"text":{"name":"Eq","title":""},"children":[]},{"text":{"name":"Name","title":3,"desc":"b"},"children":[{"text":{"name":"Load","title":""},"children":[]}]}]}';
				console.log(nodeStructure);
				nodeStructure = encodeURIComponent(nodeStructure);
				
				//createTreant(nodeStructure);

				window.open("../tree?nodeStructure=" + nodeStructure, "Tree", "height=600,width=800");
				//console.log("nyitom");
				//openWindowWithPost("../tree/", {csrfmiddlewaretoken: '{{ csrf_token }}'});

			}
			
			function readcode(){
				let source_code = document.getElementById('ta').value;

				let args = { 'source_code': source_code };
				startAnalysis(args);
			}

			function startAnalysis(args){
				py_api_request('start', args, function(data){
					data = JSON.parse(data);

					console.log(data);
					if(data['compile_success']){
						SOURCE_CODE = data['source_code'];
						

						let objectsToHide = document.getElementsByClassName("preAnalysis");
						for(let i=0; i<objectsToHide.length; i++){
							//objectsToHide[i].style.display = "none";
							objectsToHide[i].style.visibility = "hidden";
							objectsToHide[i].style.maxHeight = "0px";

						}
						let objectsToShow = document.getElementsByClassName("duringAnalysis");
						for(let i=0; i<objectsToShow.length; i++){
							//objectsToShow[i].style.display = "block";
							objectsToShow[i].style.visibility = "visible";
							objectsToShow[i].style.maxHeight = "none";
						}


						let formattedCode = getFormattedCode();
						let ki = document.getElementById('ki');
						ki.innerHTML = formattedCode;
						ki.style.height = "300px";
						let outputField = document.getElementById('outputField');
						outputField.height = "100px";



						let expressionAnalysisButton = document.getElementById('expressionAnalysisButton');
						let openTreantButton = document.getElementById('treantButton');
						let expressionAnalysisField = document.getElementById('expressionAnalysisField');


						setData(JSON.stringify(data));




						sh_highlightDocument();
					}
					else{
						document.getElementById('outputField').innerHTML = data['error_message'];
					}
				});
			}
			
			function step(){
				if(EXPRESSION_ANALYSIS_IT !== null){
					console.log("steppeljünk");
					EXPRESSION_ANALYSIS_IT ++;
					setData(null);
				}

				else{
					py_api_request('step', {}, function(data){
						setData(data);
					});
				}
			}
			
			function next(){
				if(EXPRESSION_ANALYSIS_IT !== null)
					EXPRESSION_ANALYSIS_IT = DATA['expr']['sequence'].length;

				py_api_request('next', {}, function(data){
					setData(data);
				});
			}
			
			function analyzeExpression(){
				EXPRESSION_ANALYSIS_IT = 0;

				let expressionAnalysisSpan = document.getElementById('expressionAnalysisSpan');
				//expressionAnalysisField.style.width = 50;
				expressionAnalysisSpan.innerHTML = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";
				console.log(expressionAnalysisSpan.clientWidth);
				let seq = DATA['expr']['sequence'];
				let maxWidth = 0;
				let actWidth;
				for(let i=0; i<seq.length; i++){
					expressionAnalysisSpan.innerHTML = seq[i];
					actWidth = expressionAnalysisSpan.clientWidth;
					console.log(actWidth);
					if(actWidth > maxWidth)
						maxWidth = actWidth
				}
				console.log(maxWidth);
				document.getElementById('expressionAnalysisField').style.width = 1*maxWidth;
				document.getElementById('expressionAnalysisField').style.height = "50px";

				setData(null);
			}

			function openTreant(){
				let nodeStructure = DATA['expr']['treant'];
				nodeStructure = JSON.stringify(nodeStructure);
				window.open("../tree?nodeStructure=" + nodeStructure, "Tree", "height=600,width=800");
			}
			
			function exit_code(){
				py_api_request('exit', {}, function(data){
					DATA = JSON.parse(data);
					console.log("kiléptem");
					history.go(0);
					location.reload();
					return false;
				});
			}

			function setData(data){
				if(data !== null)
					DATA = JSON.parse(data);

				if(DATA['error'] === null && DATA['isover'] === false){

					let formattedCode = getFormattedCode();
					document.getElementById('ki').innerHTML = formattedCode;
					sh_highlightDocument();
					document.getElementById('variables').innerHTML = makeTable(DATA['localvars']);
					document.getElementById('outputField').innerHTML = DATA['output'];

					addRowFunctions(DATA['localvars']);

					scrollToArrow();


					let expressionAnalysisButton = document.getElementById('expressionAnalysisButton');
					let openTreantButton = document.getElementById('treantButton');
					let expressionAnalysisField = document.getElementById('expressionAnalysisField');
					let expressionAnalysisSpan = document.getElementById('expressionAnalysisSpan');
					//ha el lehet indítani az expression anaylsis-t, de még nem indítottuk el
					if(DATA['expr'] !== null && EXPRESSION_ANALYSIS_IT === null){
						//expressionAnalysisButton.style.display = "block";
						expressionAnalysisButton.style.visibility = "visible";
						expressionAnalysisButton.style.maxHeight = "none";
					}

					//ha már megy
					else if(EXPRESSION_ANALYSIS_IT !== null &&
						DATA['expr'] !== null &&
						EXPRESSION_ANALYSIS_IT < DATA['expr']['sequence'].length){
						//expressionAnalysisButton.style.display = "none";
						expressionAnalysisButton.style.visibility = "hidden";
						expressionAnalysisButton.style.maxHeight = "0px";

						//expressionAnalysisField.style.display = "block";
						expressionAnalysisField.style.visibility = "visible";
						expressionAnalysisField.style.maxHeight = "none";

						//openTreantButton.style.display = "block";
						openTreantButton.style.visibility = "visible";
						openTreantButton.style.maxHeight = "none";

						expressionAnalysisSpan.innerHTML = DATA['expr']['sequence'][EXPRESSION_ANALYSIS_IT];
					}

					//ha nincs expression analysis
					else{
						//expressionAnalysisButton.style.display = "none";
						expressionAnalysisButton.style.visibility = "hidden";
						expressionAnalysisButton.style.maxHeight = "0px";


						//expressionAnalysisField.style.display = "none";
						expressionAnalysisField.style.visibility = "hidden";
						expressionAnalysisField.style.maxHeight = "0px";

						//openTreantButton.style.display = "none";
						openTreantButton.style.visibility = "hidden";
						openTreantButton.style.maxHeight = "0px";
						EXPRESSION_ANALYSIS_IT = null;
					}
				}

				//runtime error on user's code or code is over
				else{
					let objectsToHide = document.getElementsByClassName("duringAnalysis");
					for(let i=0; i<objectsToHide.length; i++){
						if(objectsToHide[i].classList.contains("duringError"))
							continue;
						objectsToHide[i].style.visibility = "hidden";
						objectsToHide[i].style.maxHeight = "0px";
					}
					//document.getElementById("exitCodeButton").style.display = "block";
					document.getElementById("exitCodeButton").style.visibility = "visible";
					document.getElementById("exitCodeButton").style.maxHeight = "none";
					document.getElementById('ki').style.visibility = "visible";
					document.getElementById('ki').style.maxHeight = "none";

					if(DATA['error'] !== null){
						document.getElementById('outputField').style.visibility = "visible";
						document.getElementById('outputField').style.maxHeight = "none";
						document.getElementById('outputField').innerHTML += '\n' + DATA['error'];
					}
				}
			}

			function scrollToArrow(){
				let lineno = DATA['lineno'];
				let total_lines = SOURCE_CODE.split('\n').length;
				let total_pixels = document.getElementById("ki").scrollHeight;
				let visible_pixels = document.getElementById("ki").offsetHeight;

				let scroll_to_pixel = total_pixels*lineno/total_lines - visible_pixels/2;
				document.getElementById("ki").scroll(0, scroll_to_pixel);
			}

			function getFormattedCode(){
				let lines = SOURCE_CODE.split('\n');
				let ret = "";
				for(let i=0; i<lines.length; i++){
					if(i+1 == DATA['lineno']){
						ret += "➔ ";
					}
					else{
						ret += "  ";
					}
					ret += lines[i];
					ret += "\n";
				}
				return ret;
			}
			
			function makeCodeMtx(){
				let lines = SOURCE_CODE.split('\n');
				let ret = [];
				for(let i=0; i<lines.length; i++){
					console.log(lines[i]);
					let maybeArrow = DATA['lineno'] == i+1 ? '➔' : '';
					ret.push([maybeArrow, lines[i]]);
				}
				return ret;
			}

			function addVariableButtonClicked(){
				let table = document.getElementById("variables").childNodes[0];
				let nrows = table.rows.length;
				let newRow = table.insertRow(nrows);
				newRow.classList.add("local-var");
				let cell0 = newRow.insertCell(0);
				let cell1 = newRow.insertCell(1);
				let cell2 = newRow.insertCell(2);
				let cells = [cell0, cell1, cell2];
				let inputFields = [];

				for(let i=0; i<3; i++){
					let actcell = cells[i];
					let inputField = document.createElement("INPUT");
					inputField.value = '';
					if(i < 2)
						inputField.size = 1;
					inputFields.push(inputField);
				}

				function onKeyUp(event){
					event.preventDefault();
					//let self = event.target;
					if(event.keyCode === 13 && inputFields.includes(document.activeElement)){ //ENTER
						console.log("adjuk be");
						let args = {
							'var_name': inputFields[0].value,
							'var_type': inputFields[1].value,
							'value': inputFields[2].value,
						}

						py_api_request('newvar', args, function(data){
							setData(data);
						});

					}
					else if(event.keyCode === 27){ //ESCAPE
						setData(null);
					}
				}

				for(let i=0; i<3; i++){
					inputField = inputFields[i];
					actcell = cells[i];
					inputField.addEventListener("keyup", onKeyUp);
					actcell.appendChild(inputField);
				}
			}

			function makeTable(localvars){
				console.log("maketable", localvars);
				//TODO ha esetleg html cuccok lennének a táblázat mezőiben, azokat escape-elni valahogy

				let ret = "<table border=1>";

				for(let i=0; i<localvars.length; i++){
					let v = localvars[i];
					let backgroundColor = v['is_local'] ? '#FFFFFF' : '#888888';
					if(v['is_global'] && !v['is_local']){
						ONLY_GLOBAL_POINTERS.push(v['pointer']);
					}

					ret += '<tr style="min-height:23px;" ';
					ret += 'class="pointer_' + v['pointer'];
					//ret += 'style="background-color:' + backgroundColor + '">';
					ret += v['is_local'] ? ' local-var' : ' nonlocal-var';
					ret += '">';
					ret += '<td style="min-width:10px;background-color:#FF0000">' + 'X' + "</td>";
					ret += '<td style="min-width:100px;">' + v['name'] + "</td>";
					
					if(! v['is_container']){
						
						if(! v['defined_elsewhere']){
							ret += '<td style="min-width:100px">' + v['type'] + "</td>";

							let value;
							if(v['value'] === true)
								value = 'True';
							else if(v['value'] === false)
								value = 'False';
							else if(v['value'] === null)
								value = 'None';
							else
								value = v['value'];
							ret += '<td style="white-space: pre-wrap; min-width:100px">' + value + "</td>";
						}
						else{
							ret += '<td style="min-width:100px"></td>';
							ret += '<td style="min-width:100px">( reference )</td>';
						}

					}

					else{
						ret += '<td style="min-width:100px">' + v['type'] + "</td>";
						ret += '<td style="min-width:100px">' + makeTable(v['children']) + "</td>";
					}
					ret += "</tr>";
				}

				ret += "</table>";
				return ret;
			}

			function getPointerMap(localvars, start=true){
				let ret = {};
				if(start){
					for(let i=0; i<localvars.length; i++){
						let v = localvars[i];
						ret = Object.assign({}, ret, getPointerMap(v, false));
					}
					return ret;
				} else {
					let pointer = localvars['pointer'];
					ret[pointer] = document.getElementsByClassName("pointer_" + pointer);
					for(let i=0; i<localvars['children'].length; i++){
						let v = localvars['children'][i];
						ret = Object.assign({}, ret, getPointerMap(v, false));
					}
				}
				return ret;
			}

			function addRowFunctions(localvars){
				let pointerMap = getPointerMap(localvars);
				console.log("pointermap", pointerMap);
				for(var pointer in pointerMap){
					let objArr = pointerMap[pointer];
					let className = "pointer_" + pointer;

					for(let i=0; i<objArr.length; i++){

						function mouseEnter(event){
							console.log("rajta vagyok");
							let elementsToHighlight = document.getElementsByClassName(className);
							for(let j=0; j<elementsToHighlight.length; j++){
								if(objArr[i] == elementsToHighlight[j])
									continue;
								//elementsToHighlight[j].style.backgroundColor = "#FFFF00";
								elementsToHighlight[j].classList.add('highlighted-var');
								console.log("hozzáadom");
							}
						}

						//TODO eredeti színre visszaállítani
						function mouseLeave(event){
							let elementsToHighlight = document.getElementsByClassName(className);
							for(let j=0; j<elementsToHighlight.length; j++){
								//elementsToHighlight[j].style.backgroundColor = "#FFFFFF";
								elementsToHighlight[j].classList.remove('highlighted-var');
							}
						}

						function mouseClick(event){
							if(IS_MODIFYING)
								return;

							console.log(event);
							LAST_CLICKED = event.target;
							let row = event.target;
							while(row.nodeName != "TR")
								row = row.parentElement;

							//if(row.childList

							if(row.classList.contains('nonlocal-var'))
								return;


							let leftCell = row.childNodes[1];
							let rightCell = row.childNodes[row.childNodes.length-1];

							let deleteCell = row.childNodes[0];
							if(deleteCell === event.target){
								console.log("annyi");
								let args = {'var_name': leftCell.innerText}
								py_api_request('delvar', args, function(data){
									setData(data);
								});
								
								return;
							}
							else
								console.log("ezek", deleteCell, event.target);

							let changeFrom = rightCell.innerHTML;
							let isDataStructure = rightCell.innerText !== rightCell.innerHTML;
							//rightCell.innerHTML = "változás szele";
							let inputField = document.createElement("INPUT");
							inputField.value = isDataStructure ? '' : changeFrom;
							rightCell.innerHTML = "";
							rightCell.appendChild(inputField);

							inputField.focus();
							IS_MODIFYING = true;

							inputField.addEventListener("keyup", function(event2){
								event2.preventDefault();
								let self = event2.target;
								if(event2.keyCode === 13 && self === document.activeElement){ //ENTER
									console.log("első", event2);
									console.log("changeto", self.value);
									IS_MODIFYING = false;

									//TODO elgánsabban, mikor csinálom a highlightot
									let args = {'var_name': leftCell.innerText, 'value': self.value}
									py_api_request('modify', args, function(data){
										setData(data);
									});

								}
								else if(event2.keyCode === 27){ //ESCAPE
									IS_MODIFYING = false;
									rightCell.innerHTML = changeFrom;
									rightCell.removeChild(self);
								}
							});
						}

						objArr[i].addEventListener("mouseover", mouseEnter);
						objArr[i].addEventListener("mouseleave", mouseLeave);
						objArr[i].addEventListener("click", mouseClick);
					}
				}
			}

		var IS_MODIFYING = false;
		var LAST_CLICKED;

		</script>
	</head>
	<body onload="document.getElementById('selectExample').selectedIndex=0;">
		<div id="container">
			<div id="header">
				<img src="/static/banner.png" alt="Step-py-Step banner" style="width:400px">
			</div>

			<div id="content">
				<div id="columns-container">
					<div class="column column-a">

						<textarea id="ta" name="content" class="preAnalysis" rows="15" cols="75">{{usercode}}</textarea>
						<script type="text/javascript" src="{% static 'allowtabs.js' %}"></script>

					
						<div class="preAnalysis">
							<select id="selectExample" class="preAnalysis" onchange="onSelectExample(this)">
								<option selected value="">Select example</option>
							{% for example_file in example_files %}
								<option value="{{example_file}}">{{example_file}}</option>
							{% endfor %}
							</select><br>
							<script>
								function onSelectExample(x){
									let filename = x.selectedOptions[0].value;
									if(filename){
										let args = { 'example_file_name': filename };
										startAnalysis(args);
									}
								}
							</script>

							<form method="post" enctype="multipart/form-data">
								{% csrf_token %}
								<input class="preAnalysis" type="file" name="usercode" onchange="onFileUpload(this)">
							</form>
							<script>
								function onFileUpload(x){
									if(x.files[0].size > 1024*1024)
										alert("Uploaded file is too big (max size is 1 MB)");
									else
										x.form.submit();
								}
							</script>
							
							<button class="preAnalysis" onclick="readcode()">Read code</button> 
							<br>
						</div>

						<pre class="sh_python duringAnalysis duringError">
							<p id="ki" class="duringAnalysis duringError" style="overflow-y: scroll; height:0px; visibility: hidden"></p>
						</pre>
						<!--<button class="duringAnalysis" onclick="step()" style="display:none;">Step</button><br>-->
						<div class="duringAnalysis">
							<button class="duringAnalysis button" onclick="step()" style="visibility:hidden;max-height:0px;">Step</button><br>
							<button class="duringAnalysis button" onclick="next()" style="visibility:hidden;max-height:0px;">Next</button><br>
						</div>
						<div id="expressionAnalysisButton" class="duringExpressionAnalysis" style="visibility:hidden;max-height:0px;">
							<button onclick="analyzeExpression()" class="button">Analyize Expression</button><br>
						</div>
						<div id="treantButton" class="duringExpressionAnalysis" style="visibility:hidden;max-height:0px;">
							<button onclick="openTreant()" class="button">Abstract Syntax Tree</button>
							<br>
						</div>
						<div id="duringAnalysis duringError">
							<button id="exitCodeButton" class="duringAnalysis" onclick="exit_code()" style="visibility:hidden;max-height:0px;">Exit code</button>
							<br>
						</div>
						<!--<button onclick="testButtonPressed()">Teszt</button>-->
						<pre class="duringAnalysis duringError sh_python" style="visibility: hidden; max-height: 0px;">
							<p>---Output---</p>
							<p id="outputField" style="overflow-y: scroll;"></p>
							<!--<textarea id="outputField"></textarea>-->
						</pre>
					</div>
					<div class="column column-b">
						<div class="duringAnalysis" style="visibility: hidden; max-height: 0px;">
							<button onclick="addVariableButtonClicked();">Add variable</button>
						</div>
						<pre style="
									visibility:hidden;
									max-height:0px;
									padding:10px;"
									class="duringExpressionAnalysis sh_python" id="expressionAnalysisField">
							<span	id="expressionAnalysisSpan"
									style="float:left;"></span>
						</pre>
						<pre>
							<p id="variables"></p>
						</pre>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>