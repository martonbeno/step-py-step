<html>
	<head>
		{% load static %}
		<link rel="stylesheet" href="{% static 'style.css' %}">

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script>
			var SOURCE_CODE = '';
			var DATA = {'lineno':1, 'localvars':[]};
			
			
			function py_api_request(command, args, callback){
				$.ajax({
					url: '/api/',
					method: 'POST',
					data: {
						command: command,
						args: JSON.stringify(args),
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					success: callback
				}).done(function(msg) {
					//semmi
				});
			}
			
			function readcode(){
				let source_code = document.getElementById('ta').value;
				let args = { 'source_code': source_code };
				py_api_request('start', args, function(data){
					SOURCE_CODE = data;
					document.getElementById('ta').style.display = "none";
					document.getElementById('readcode_button').style.display = "none";
					let formattedCode = getFormattedCode();
					document.getElementById('ki').innerHTML = formattedCode;
				});
				
			}
			
			function step(){
				py_api_request('step', {}, function(data){
					DATA = JSON.parse(data);
					let formattedCode = getFormattedCode();
					document.getElementById('ki').innerHTML = formattedCode;
					document.getElementById('variables').innerHTML = makeTable(DATA['localvars']);
				});
			}
			
			function exit_code(){
				py_api_request('exit', {}, function(data){
					DATA = JSON.parse(data);
					console.log("kiléptem");
					location.reload();
					return false;
				});
			}

			function getFormattedCode(){
				let lines = SOURCE_CODE.split('\n');
				let ret = "";
				for(let i=0; i<lines.length; i++){
					if(i+1 == DATA['lineno']){
						ret += "➔ ";
					}
					else{
						ret += "  ";
					}
					ret += lines[i];
					ret += "\n";
				}
				return ret;
			}
			
			function makeCodeMtx(){
				let lines = SOURCE_CODE.split('\n');
				let ret = [];
				for(let i=0; i<lines.length; i++){
					console.log(lines[i]);
					let maybeArrow = DATA['lineno'] == i+1 ? '➔' : '';
					ret.push([maybeArrow, lines[i]]);
				}
				return ret;
			}

			function makeSmallTable(localvars){
				let ret = "<table border=1>";
					ret += "<tr>";
						ret += "<td>";
							ret += "kicsi";
						ret += "</td>";
						ret += "<td>";
							ret += "táblázat";
						ret += "</td>";
					ret += "</tr>";
				ret += "</table>";
				return ret
			}

			function makeTable(localvars){
				//TODO ha esetleg html cuccok lennének a táblázat mezőiben, azokat escape-elni valahogy

				let ret = "<table border=1>";

				for(let i=0; i<localvars.length; i++){
					let v = localvars[i];

					ret += "<tr>";
					ret += "<td>" + v['name'] + "</td>";
					if(! v['is_udt']){
						
						if(! v['defined_elsewhere']){
							ret += "<td>" + v['type'] + "</td>";
							ret += "<td>" + v['value'] + "</td>";
						}
						else{
							ret += "<td></td>";
							ret += "<td>máshol definiált</td>";
						}

					}

					else{
						ret += "<td>" + v['type'] + "</td>";
						ret += "<td>" + makeTable(v['children']) + "</td>";
					}
					ret += "</tr>";
				}

				ret += "</table>";
				return ret;
			}
			
			
			//stackoverflow
			function makeTableHTML(myArray) {
				var result = "<table border=1>";
				for(var i=0; i<myArray.length; i++) {
					result += "<tr>";
					for(var j=0; j<myArray[i].length; j++){
						result += "<td>"+myArray[i][j]+"</td>";
					}
					result += "</tr>";
				}
				result += "</table>";

				return result;
			}

		</script>
	</head>
	<body>
		<div class="split left">
			<form method="post" action="/create/">
				<textarea id="ta" name="content" rows="15" cols="75"></textarea>
			</form>
			
			<pre>
				<p id="ki"></p>
			</pre>
			
			<button id="readcode_button" onclick="readcode()">Read code</button><br>
			<button onclick="step()">Step</button><br>
			<button onclick="exit_code()">Exit code</button>
		</div>
		<div class="split right">
			<pre>
				<p id="variables"></p>
			</pre>
		</div>
		
	</body>
</html>